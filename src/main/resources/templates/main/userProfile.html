<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" >
<!=== Head in Thymeleaf - Fragments ===>
<head th:replace="partials/head.html :: head ('uesr Profile')" ></head>
<body>

<!===== Navbar =====>
<nav th:replace="partials/loginNavbar :: LoggedIn-Navbar"></nav>



<main class="container-fluid">
    <div class="row">
        <!===== Left Side, User Profile Image and Details =====>
        <div id="left-side-user-info-container" class="col-12 col-sm-4 col-md-4">
            <div id="user-profile-info">
                <!===  Settings Button ====>
                <aside id="setting-button-container" class="setting-container">
                    <img th:src="@{/img/settings.png}" alt="Setting Button">
                </aside>
                <!=== Profile IMG ===>
                <section class="user-profile-picture-container">
                    <img class="user-profile-picture" th:src="@{img/noProfileImage.png}" th:if="${user.profilePicturePath == ''}" alt="No Image Provided" />
                    <img class="user-profile-picture" th:src="${profilePathway}" th:if="${user.profilePicturePath != ''}" th:alt="${user.getUsername()}">
                    <button class="button-17 mt-3">Add Friend</button>
                </section>
                <!=== User Details ===>
                <section class="user-details-container">
                    <h2 class="user-username"> Hello <span th:text="${user.getUsername()}">username</span></h2>
                    <p class="user-bio" th:unless="${user.getBio() == ''}" th:text="${user.getBio() != null ? user.getBio().substring(0, 1).toUpperCase() + user.getBio().substring(1) : 'No Bio'}"></p>
                    <hr class="w-75 mx-auto">
                    <small class="fav-genre-title">Favorite Genre:</small>
                    <aside class="user-fav-genre-container">
                        <span th:each="favoriteGenre : ${favoriteGenres}" th:text="${favoriteGenre.genre.name}"></span>
                    </aside>
                </section>
            </div>
            <!=== Settings Form ===>
            <div id="setting-form-container">
                <form th:action="@{/in/{id} (id=${user.getId()})}"
                        th:object="${user}"
                        method="post"
                      enctype="multipart/form-data">
                    <h3>Settings</h3>
                    <!-- Profile Picture -->
                    <div class="mb-3">
                        <label for="setting-profile-picture" class="form-label">Profile Picture:</label>
                        <input class="form-control" type="file" id="setting-profile-picture" th:field="*{profilePictureFile}">
                    </div>
                    <!-- First Name -->
                    <div class="mb-3">
                        <label for="setting-first-name" class="form-label">First Name:</label>
                        <input type="text"
                               title="Uppercase & Lowercase letters only, no punctuation, numbers, or special characters and between 3 and 30 characters"
                               class="form-control"
                               th:field="*{first_name}"
                               th:value="${first_name}"
                               id="setting-first-name"
                               pattern="[a-zA-Z]{3,30}">
                    </div>
                    <!-- Last Name -->
                    <div class="mb-3">
                        <label for="setting-last-name" class="form-label">Last Name:</label>
                        <input type="text"
                               class="form-control"
                               id="setting-last-name"
                               th:field="*{last_name}"
                               th:value="${last_name}"
                               minlength="3"
                               maxlength="30"
                               title="Uppercase & Lowercase letters only, no punctuation, numbers, or special characters and between 3 and 30 characters"
                               pattern="[a-zA-Z]{3,30}">
                    </div>
                    <!-- Username -->
                    <div class="mb-3">
                        <label for="setting-username" class="form-label">Username:</label>
                        <input type="text"
                               class="form-control"
                               id="setting-username"
                               th:value="${username}"
                               th:field="*{username}">
                    </div>
                    <!-- Email -->
                    <div class="mb-3">
                        <label for="settingsEmail" class="form-label">Email address</label>
                        <input type="email"
                               class="form-control"
                               id="settingsEmail"
                               minlength="6"
                               maxlength="254"
                               pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                               th:value="${email}"
                               th:field="*{email}"
                               title="Please provide a valid email">
                    </div>
                    <!-- password -->
                    <div class="mb-3">
                        <label for="settingsPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="settingsPassword" aria-describedby="passwordHelp" th:field="*{password}">
                        <div id="passwordHelp">Your password must be 8-20 characters long, 2 Uppercase & 2 Lowercase, 2 Numbers, 2 Special Characters</div>
                    </div>
                    <!-- Bio -->
                    <div class="mb-3">
                        <label for="setting-bio" class="form-label">Bio:</label>
<!--                        <textarea th:value="${user.getBio()}" class="form-control" id="setting-bio" rows="3"></textarea>-->
                        <textarea
                                  class="form-control"
                                  id="setting-bio"
                                  rows="3"
                                  style="resize: none;"
                                  th:field="*{bio}"
                                  th:value="${bio}">
                        </textarea>
                    </div>
                    <!-- Cancel Button -->
                    <button type="button" id="setting-cancel-button" class="btn btn-secondary">Cancel</button>
                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary">Submit</button>
                    <input type="hidden" th:field="*{id}" th:value="${user.id}">
                </form>
            </div>
        </div>

        <!===== Right Side, User Reviews =====>
        <div id="right-side-user-reviews-container" class="col-12 col-sm-8 col-md-8">
            <!=== Review Title ===>
            <div class="section-title">
                <h2>Reviews</h2>
            </div>
            <!=== Review Container ===>
            <div class="row">
                <!=== Each Review ===>
                <div class="user-reviews-container col-11 col-md-9 col-lg-5 row" th:if="${usersReview != null and not #lists.isEmpty(usersReview)}" th:each="review:${usersReview}">
                    <!=== Review Book Info Container ===>
                    <section class="col-3 col-lg-4">
                        <a th:href="@{/singleBook/{id}(id = ${review.getBookshelf().getId()})}" >
                            <img class="user-profile-book-cover" th:src="@{/img/noImage.jpeg}" th:if="${review.getBookshelf().getCover_page() == ''}" alt="No Image Provided" />
                            <img class="user-profile-book-cover" th:src="${review.getBookshelf().getCover_page()}" th:if="${review.getBookshelf().getCover_page() != ''}" th:alt="${review.getBookshelf().getTitle()}" />
                        </a>
                    </section>
                    <!=== Review Container ===>
                    <section class="col-9 col-lg-8">
                        <!===  Review Title ====>
                        <span  class="user-review-title" th:text="${review.title}">Review Title</span>
                        <img th:src="@{/img/edit-button.png}" class="edit-review-button" alt="Edit Button">
                       <br/>
                        <!===  Review Rating ====>
                        <span th:switch="${review.rating}" class="">
                            <img th:case="'0'" th:src="@{/img/ratings/noStar.png}" th:alt="${review.rating}" class="user-review-book-rating">
                            <img th:case="'1'" th:src="@{/img/ratings/oneStar.png}" th:alt="${review.rating}" class="user-review-book-rating">
                            <img th:case="'2'" th:src="@{/img/ratings/twoStars.png}" th:alt="${review.rating}" class="user-review-book-rating">
                            <img th:case="'3'" th:src="@{/img/ratings/threeStars.png}" th:alt="${review.rating}" class="user-review-book-rating">
                            <img th:case="'4'" th:src="@{/img/ratings/fourStars.png}" th:alt="${review.rating}" class="user-review-book-rating">
                            <img th:case="'5'" th:src="@{/img/ratings/fiveStars.png}" th:alt="${review.rating}" class="user-review-book-rating">
                        </span>
                        <!===  Review Body ====>
                        <p th:text="${review.body}">Review Body</p>
                    </section>
                </div>
                <div class="no-reviews-message" th:unless="${usersReview != null and not #lists.isEmpty(usersReview)}">
                    No recent reviews
                </div>
            </div>
        </div>
    </div>
</main>











<script>
    //-- Container for all book results.
    const searchBookContainer = document.getElementById("book-search-results");
    //-- Input for book search
    const searchBookInput = document.getElementById("book-search-input");


    const searchBookCancelButton = document.getElementById("search-result-cancel-button");


    const logoutButton = document.getElementById("logout-button");


    //-- everytime the page reloads the search input value is always going to reset.
    document.addEventListener("DOMContentLoaded", () => {
        searchBookInput.value = "";
        searchBookCancelButton.style.display = 'none'
        logoutButton.style.display = 'block'

    })
    searchBookCancelButton.addEventListener("click", () =>{
        logoutButton.style.display = "block";
        searchBookInput.value = "";
        searchBookCancelButton.style.display = 'none'
        showSearchBook()
    })

    //-- Create a function that when user is pressing enter then start the code:
    searchBookInput.addEventListener("keydown", (e)=> {
        logoutButton.style.display = 'none';
        searchBookCancelButton.style.display = 'block'
        if (e.keyCode === 13){
            console.log("Enter Pressed");
            searchBookContainer.innerHTML = ` <div class='prompt'><div class="loading-image"></div></div>`
            return setTimeout(()=>{showSearchBook()}, 800)
        }
    })



    //-- Now what to do when you have your search results press enter then what?

    // -- Create a function that will search for an input in the nav.
    //    will be using DOM to accomplish this.
    const showSearchBook = async () => {
        //-- Search for input
        if (searchBookInput.value !== "") {
            searchBookContainer.style.display = "flex";

            // Crate a function named getBooks that fetches the API.
            const getBooks = async (book) => {
                const response = await fetch(
                    `https://www.googleapis.com/books/v1/volumes?q=${book}&printType=books`
                );
                const data = await response.json();
                return data;
            }

            console.log("Working")

            //-- Data is going to call the function to get the books
            const data = await getBooks(`${searchBookInput.value}&maxResults=10`);
            //-- data
            if (data.error) {
                searchBookContainer.innerHTML = `<div>Network Problem</div>`
            } else if (data.totalItems === 0) {
                searchBookContainer.innerHTML = `<div class='prompt'>Try a different term</div>`;
            } else if (data.totalItems === undefined) {
                searchBookContainer.innerHTML = `<div class='prompt'>Network problem!</div>`;
            } else {
                searchBookContainer.innerHTML = data.items.map( (({ volumeInfo }) => {
                    console.log(volumeInfo);
                   return `<div class="nav-bar-search-form-container">
                            <form method="POST" action="">
                               <input type="hidden" name="_CSRF" value="$(searchBookInput.val())" />
                               <input type="hidden" name="title" value="${volumeInfo.title}" />
                               <input type="hidden" name="isbn" value="${volumeInfo.industryIdentifiers[0].identifier}" />
                               <input type="hidden" name="author" value="${volumeInfo.authors[0]}" />
                               <input type="hidden" name="bookImage" value="${volumeInfo.imageLinks.thumbnail}" />
                               <input type="hidden" name="averageRating" value="${volumeInfo.averageRating}" />
                               <input type="hidden" name="descrition" value="${volumeInfo.description}"/>
                               <input type="hidden" name="genreCategories"  th:value="${volumeInfo.categories}" />
                               <input type="hidden" name="pageCount"  th:value="${volumeInfo.pageCount}" />
                               <input type="hidden" name="publishedDate"  th:value="${volumeInfo.publishedDate}" />
                               <input type="hidden" name="publishedDate"  th:value="${volumeInfo.publishedDate}" />
                               <input type="hidden" name="googlePlay"  th:value="${volumeInfo.infoLink}" />
                               <button type="submit" class="btn">
                                    <img class="search-book-results-book-cover" src="${volumeInfo.imageLinks.thumbnail}" alt="${volumeInfo.title}">
                                    <div class="nav-search-book-info-container">
                                        <h4 class="nav-search-book-result-title">
                                            <div class="nav-search-book-results">${volumeInfo.title}</div>
                                        </h4>
                                        <div class="nav-search-bar-results-authors">${volumeInfo.authors[0]}</div>
                                    </div>
                               </button>
                            </form>
                    </div>`
                    }
                ))
            }
        }else{
            searchBookContainer.style.display = "none";
        }
    }







</script>





<!=== Footer ===>
<footer th:replace="partials/footer.html :: Footer"></footer>
<script th:src="@{/js/userProfile.js}"></script>
</body>
</html>